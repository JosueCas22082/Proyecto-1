;***************************
;Universidad del Valle de Guatemala
;IE2023: Programacion de microcontroladores
;Autor: Josue Castro
;Proyecto 
;
;***************************************************************************
;Encabezado
;***************************************************************************
.include "M328PDEF.INC"
.cseg 
.def ESTADO = R23
.org 0x00
	JMP		MAIN

.org 0x0006
	JMP		ISR_PCINT0

.org 0x0012
	JMP		ISR_TIMER2

.org 0x0020
	JMP		ISR_TIMER0

;***************************************************************************
;Tabla de valores (ánodo común)
;*********		   0     1    2      3    4     5     6     7    8     9
TABLA7SEG: .DB	 0x40, 0x79, 0x24, 0x30, 0x19,0x12, 0x02, 0x78, 0x00, 0x10


MAIN:
;*********
;Stack
;*********
	LDI		R16, LOW(RAMEND)
	OUT		SPL, R16 
	LDI		R17, HIGH(RAMEND)
	OUT		SPL, R17

;*********
;Configuracion
;*********
SETUP:
	//OSCILADOR
	LDI		R16, (1 << CLKPCE)	;HABILITA EL PRESCALER
	STS		CLKPR, R16 
	LDI		R16, 0				;OSCILADOR DE 16MHz
	STS		CLKPR, R16
	
	//SALIDAS Y ENTRADAS
	LDI		R16, 0b0000_0000	;
	STS		UCSR0B, R16			;DESABILITO TX Y RX
	LDI		R16, 0b0001_1111	;
	OUT		PORTB, R16			;COLOCO EL PUERTO B COMO PULL-UP
	LDI		R16, 0b1110_0000	;
	OUT		DDRB, R16			;COLOCO EL PUERTO B COMO ENTRADA
	LDI		R16, 0b1111_1111	;
	OUT		DDRC, R16			;COLOCO EL PUERTO C COMO SALIDA
	LDI		R16, 0b1111_1111	;
	OUT		DDRD, R16			;COLOCO EL PUERTO D COMO SALIDA

	//INTERRUPCIONES
	LDI		R16, 7
	STS		PCMSK0, R16			;HABILITA PCINT0 y PCINT1
	LDI		R16, 1				;
	STS		PCICR, R16			;HABILITA PCIE0

	LDI		R16, 0
	OUT		TCCR0A, R16			;CONTADOR NORMAL
	LDI		R16, 5
	OUT		TCCR0B, R16			;PRESCALER 1024
	LDI		R16, 1				;
	STS		TIMSK0, R16			;HABILITA TOIE0
	LDI		R16, 99				;
	OUT		TCNT0, R16			;VALOR INICIAL

	LDI		R16, 0
	STS		TCCR2A, R16			;CONTADOR NORMAL
	LDI		R16, 7
	STS		TCCR2B, R16			;PRESCALER 1024
	LDI		R16, 1				;
	STS		TIMSK2, R16			;HABILITA TOIE2
	LDI		R16, 99				;
	STS		TCNT2, R16			;VALOR INICIAL

	//REGISTROS

	LDI		R16, 0				;AUXILIAR O TEMPORAL
	LDI		R17, 0

	LDI		R18, 0				;UNIDADES MINUTOS
	LDI		R19, 0				;DECENAS MINUTOS

	LDI		R20, 0				;CONTADOR DE ESTADOS
	LDI		R21, 0				;CONTADOR DE 10MS
	LDI		R24, 0				;CONTADOR DE SEGUNDOS
	LDI		R22, 0				;CAMBIO DE PARPADEO DE DISPLAY

	LDI		R25, 0				;DIAS
	CLR		ESTADO
	LDI		R30, 0				;CONTADOR DE UNIDADES - MINUTOS
	LDI		R31, 0				;CONTADOR DE DECENAS - MINUTOS
	LDI		R26, 0				;CONTADOR DE DECENAS - HORAS
	LDI		R27, 0				;CONTADOR DE DECENAS - HORAS

	LDI		R28, 0				;UNIDADES HORAS
	LDI		R29, 0				;DECENAS HORAS

	LDI		R30, 1
	MOV		R8, R30
	LDI		R30, 1
	MOV		R9, R30
	LDI		R30, 1
	MOV		R11, R30
	LDI		R30, 1
	MOV		R13, R30
	CLR		R12
	CLR		R14
	CLR		R15
	CLR		R10
	CLR		R7
	CLR		R6
	CLR		R5
	LPM		R18, Z
	OUT		PORTD, R18

	LPM		R19, Z
	OUT		PORTD, R19

	LPM		R28, Z
	OUT		PORTD, R28

	LPM		R29, Z
	OUT		PORTD, R29
	SEI

;*********
;Bucle infinito
;*********
LOOP:
	CPI		R24, 60					; VERIFICASMO SI R24 = 60 PARA QUE HAGA 60S
	BRNE	ESTADO0				    ; SI NO SON IGUALES
	LDI		R24,0					; SI SON IGUALES REINICIA R24

	INC		R25
	
	CPI		R25, 10					; VERIFICA SI ES EL VALOR MAXIMO 
	BRNE	ESTADO0				    ; SI NO SON IGUALES
	LDI		R25, 0

	INC		R26
	
	CPI		R26, 6					; VERIFICA SI ES EL VALOR MAXIMO 
	BRNE	ESTADO0				    ; SI NO SON IGUALES
	LDI		R26, 0

	INC		R27
	CPI		R27, 24
	BRNE	DIA
	LDI		R27, 0
	CLR		R14
	CLR		R15

	CALL	MESES

	RJMP	ESTADO0

DIA:
	INC		R15

	MOV     R30, R15
	CPI		R30, 10					; VERIFICA SI ES EL VALOR MAXIMO 
	BRNE	ESTADO0					; SI NO SON IGUALES
	CLR		R15

	INC		R14


ESTADO0:
	CPI		ESTADO, 0
	BRNE	ESTADO1

	CALL	HORA

	RJMP	LOOP

ESTADO1:
	CPI		ESTADO, 1
	BRNE	ESTADO2

	CALL	FECHA

	RJMP	LOOP

ESTADO2:
	CPI		ESTADO, 2
	BRNE	ESTADO3

	CALL	CONFIG_HORA1

	RJMP	LOOP

ESTADO3:
	CPI		ESTADO, 3
	BRNE	ESTADO4

	CALL	CONFIG_HORA2

	RJMP	LOOP

ESTADO4:
	CPI		ESTADO, 4
	BRNE	ESTADO5

	CALL	CONFIG_FECHA1

	RJMP	LOOP

ESTADO5:
	CPI		ESTADO, 5
	BRNE	ESTADO6

	CALL	CONFIG_FECHA2

	RJMP	LOOP

;***MESES***
MESES:
	MOV		R30, R9
	CPI		R30, 1
	BRNE	MES2
	CALL	MES31
	RJMP	SALIR_MESES
MES2:
	MOV		R30, R9
	CPI		R30, 2
	BRNE	MES3
	CALL	MES28
	RJMP	SALIR_MESES
MES3:
	MOV		R30, R9
	CPI		R30, 3
	BRNE	MES4
	CALL	MES31
	RJMP	SALIR_MESES
MES4:
	MOV		R30, R9
	CPI		R30, 4
	BRNE	MES5
	CALL	MES30
	RJMP	SALIR_MESES
MES5:
	MOV		R30, R9
	CPI		R30, 5
	BRNE	MES6
	CALL	MES31
	RJMP	SALIR_MESES
MES6:
	MOV		R30, R9
	CPI		R30, 6
	BRNE	MES7
	CALL	MES30
	RJMP	SALIR_MESES
MES7:
	MOV		R30, R9
	CPI		R30, 7
	BRNE	MES8
	CALL	MES31
	RJMP	SALIR_MESES
MES8:
	MOV		R30, R9
	CPI		R30, 8
	BRNE	MES9
	CALL	MES31
	RJMP	SALIR_MESES
MES9:
	MOV		R30, R9
	CPI		R30, 9
	BRNE	MES10
	CALL	MES30
	RJMP	SALIR_MESES
MES10:
	MOV		R30, R9
	CPI		R30, 10
	BRNE	MES11
	CALL	MES31
	RJMP	SALIR_MESES
MES11:
	MOV		R30, R9
	CPI		R30, 11
	BRNE	MES12
	CALL	MES30
	RJMP	SALIR_MESES
MES12:
	MOV		R30, R9
	CPI		R30, 12
	BRNE	MESS
	CALL	MES31
	RJMP	SALIR_MESES
MESS:
	CLR		R9
	CLR		R10
	CLR		R12
	LDI		R30, 1
	MOV		R11, R30
	LDI		R30, 1
	MOV		R13, R30
	LDI		R30, 1
	MOV		R9, R30
	LDI		R30, 1
	MOV		R8, R30
SALIR_MESES:
	RET

;***MES DE 30***
MES30:
	MOV		R30, R8
	CPI		R30, 30
	BRNE	M30

	INC		R9	
	INC		R11
	MOV		R30, R11
	CPI		R30, 10
	BRNE	S30
	LDI		R30, 0
	MOV		R11, R30
	INC		R10
S30:
	LDI		R30, 1
	MOV		R13, R30
	CLR		R12
	LDI		R30, 1
	MOV		R8, R30
	RJMP	SM30
M30:
	INC		R8
	INC		R13
	MOV		R30, R13
	CPI		R30, 10
	BRNE	SM30
	CLR		R13

	INC		R12
SM30:
	RET

;***MES DE 31***
MES31:
	MOV		R30, R8
	CPI		R30, 31
	BRNE	M31
	
	MOV		R30, R9
	CPI		R30, 12
	BRNE	S31
	CLR		R9
	CLR		R11
	CLR		R10
	CLR		R12
S31:
	INC		R9	
	INC		R11
	LDI		R30, 1
	MOV		R13, R30
	CLR		R12
	LDI		R30, 1
	MOV		R8, R30
	RJMP	SM31
M31:
	INC		R8
	INC		R13
	MOV		R30, R13
	CPI		R30, 10
	BRNE	SM31
	CLR		R13

	INC		R12
SM31:
	RET

;***MES DE 28***
MES28:
	MOV		R30, R8
	CPI		R30, 28
	BRNE	M28

	INC		R9	
	INC		R11
	LDI		R30, 1
	MOV		R13, R30
	CLR		R12
	LDI		R30, 1
	MOV		R8, R30
	RJMP	SM28
M28:
	INC		R8
	INC		R13
	MOV		R30, R13
	CPI		R30, 10
	BRNE	SM28
	CLR		R13

	INC		R12
SM28:
	RET



;********HORA**********
HORA:
	ADD		ZL, R25
	LPM		R18, Z					; CARGA A R20 EL VALOR DE ESA POSICION
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)

	ADD		ZL, R26
	LPM		R19, Z
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)

	ADD		ZL, R15
	LPM		R28, Z					; CARGA A R20 EL VALOR DE ESA POSICION
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)

	ADD		ZL, R14
	LPM		R29, Z					; CARGA A R20 EL VALOR DE ESA POSICION
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)
	RET


;********FECHA*********
FECHA:
	sbi		PINB, PB5
	ADD		ZL, R11
	LPM		R18, Z					; CARGA A R20 EL VALOR DE ESA POSICION
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)

	ADD		ZL, R10
	LPM		R19, Z
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)

	ADD		ZL, R13
	LPM		R28, Z					; CARGA A R20 EL VALOR DE ESA POSICION
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)

	ADD		ZL, R12
	LPM		R29, Z					; CARGA A R20 EL VALOR DE ESA POSICION
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)
	RET


;******CONFIGURACION-HORA********
CONFIG_HORA1:
	LDI		R28, 95
	LDI		R29, 95

	ADD		ZL, R7
	LPM		R18, Z					; CARGA A R20 EL VALOR DE ESA POSICION
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)

	ADD		ZL, R6
	LPM		R19, Z					; CARGA A R20 EL VALOR DE ESA POSICION
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)
	RET

CONFIG_HORA2:
	LDI		R18,95
	LDI		R19, 95

	ADD		ZL, R7
	LPM		R28, Z					; CARGA A R20 EL VALOR DE ESA POSICION
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)

	ADD		ZL, R6
	LPM		R29, Z					; CARGA A R20 EL VALOR DE ESA POSICION
	LDI		ZL, LOW(TABLA7SEG << 1)
	LDI		ZH, HIGH(TABLA7SEG << 1)
	RET

;******CONFIGURACION-FECHA*******
CONFIG_FECHA1:
	LDI		R18, 6
	LDI		R19, 7
	LDI		R28, 6
	LDI		R29, 7
	RET

CONFIG_FECHA2:
	LDI		R18, 6
	LDI		R19, 7
	LDI		R28, 6
	LDI		R29, 7
	RET



;*********
;VECTOR INTERRUPCION 1
ISR_PCINT0:
	PUSH	R16					;GUARDAMOS EN LA PILA
	IN		R16, SREG			;
	PUSH	R16					;

BOTON:
	SBIC	PINB, PB0			;VERIFICASMOS SI PINB0 ES IGUAL A 0
	RJMP	BOTON2				;SI NO ES IGUAL A 0
	INC		R20					;SI ES IGUAL A 0, INCREMENTAMOS
	
	CPI		R20, 0
	BRNE	NEXT0
	RJMP	ESTADO_0
NEXT0:
	CPI		R20, 1
	BRNE	NEXT1
	RJMP	ESTADO_1
NEXT1:					
	CPI		R20, 2
	BRNE	NEXT2
	RJMP	ESTADO_2
NEXT2:					
	CPI		R20, 3
	BRNE	NEXT3
	RJMP	ESTADO_3
NEXT3:					
	CPI		R20, 4
	BRNE	NEXT4
	RJMP	ESTADO_4
NEXT4:					
	CPI		R20, 5
	BRNE	NEXT5
	RJMP	ESTADO_5
NEXT5:
	CPI		R20, 6
	BRNE	NEXT6
	RJMP	ESTADO_6
NEXT6:
	CPI		R20, 7
	BRNE	NEXT7
	RJMP	ESTADO_7
NEXT7:
	CPI		R20, 8
	BRNE	SALIR_PCINT0
	LDI		R20,0
	RJMP	ESTADO_8
	
	
ESTADO_0:
	NOP
	RJMP	SALIR_PCINT0		;

ESTADO_1:
	LDI		ESTADO, 0
	RJMP	SALIR_PCINT0		;

ESTADO_2:
	LDI		ESTADO, 1
	RJMP	SALIR_PCINT0		;

ESTADO_3:
	LDI		ESTADO, 2
	RJMP	SALIR_PCINT0		;

ESTADO_4:
	LDI		ESTADO, 3
	RJMP	SALIR_PCINT0		;

ESTADO_5:
	LDI		ESTADO, 4
	RJMP	SALIR_PCINT0		;

ESTADO_6:
	LDI		ESTADO, 5
	RJMP	SALIR_PCINT0		;

ESTADO_7:
	LDI		ESTADO, 6
	RJMP	SALIR_PCINT0		;

ESTADO_8:
	LDI		ESTADO, 7
	RJMP	SALIR_PCINT0		;

BOTON2:
	CALL	BOTON_2
	CALL	BOTON_3	

SALIR_PCINT0:	
	POP		R16					;SACAMOS DE LA PILA
	OUT		SREG, R16			;
	POP		R16					;
	RETI



;*********
;VECTOR INTERRUPCION 2
ISR_TIMER0:
	PUSH	R16					;GUARDAMOS EN LA PILA
	IN		R16, SREG			;
	PUSH	R16					;
		
	INC		R22
	CPI		R22, 1
	BRNE	DOS
	OUT		PORTD, R18
	SBI		PORTC, PC0
	CBI		PORTC, PC1
	CBI		PORTC, PC2
	CBI		PORTC, PC3

	RJMP	UNO	
DOS:
	CPI		R22, 2
	BRNE	TRES
	OUT		PORTD, R19
	CBI		PORTC, PC0
	SBI		PORTC, PC1
	CBI		PORTC, PC2
	CBI		PORTC, PC3

	RJMP	UNO	
TRES:
	CPI		R22, 3
	BRNE	CUATRO
	OUT		PORTD, R28
	CBI		PORTC, PC0
	CBI		PORTC, PC1
	SBI		PORTC, PC2
	CBI		PORTC, PC3
	
	RJMP	UNO
CUATRO:
	CPI		R22, 4
	BRNE	ZERO
	OUT		PORTD, R29
	CBI		PORTC, PC0
	CBI		PORTC, PC1
	CBI		PORTC, PC2
	SBI		PORTC, PC3
	LDI		R22, 0

	RJMP	UNO

ZERO:
	NOP
UNO: 
	LDI		R16, 99			;99 (RAPIDO 250)
	OUT		TCNT0, R16			;VALOR INICIAL 

	POP		R16					;SACAMOS DE LA PILA
	OUT		SREG, R16			;
	POP		R16					;
	RETI


;*********
;VECTOR INTERRUPCION 3
ISR_TIMER2:
	PUSH	R16					;GUARDAMOS EN LA PILA
	IN		R16, SREG			;
	PUSH	R16					;
	
	INC		R21				 	    ;INCREMENTAMOS EL CONTADOR DE LOS 10MS 
	CPI		R21, 100			; VERIFICASMO SI R21 = 100 PARA QUE HAGA 1S
	BRNE	NO21					; SALTAMOS AL ESTADO INICIAL
	LDI		R21,0					; SI SON IGUALES REINICIA R21
	INC		R24
NO21:
	INC		R17
	CPI		R17, 50
	BRNE	NO50
	SBI		PORTC, PC4
	SBI		PORTC, PC5
	JMP		SALIR_T2
NO50:
	CPI		R17, 100
	BRNE	SALIR_T2
	CLR		R17
	CBI		PORTC, PC4
	CBI		PORTC, PC5
SALIR_T2:

	LDI		R16, 99				
	STS		TCNT2, R16		

	POP		R16					;SACAMOS DE LA PILA
	OUT		SREG, R16			;
	POP		R16	
	RETI


;*********************
BOTON_2:
	SBIC	PINB, PB1			;VERIFICASMOS SI PINB0 ES IGUAL A 0
	RJMP	SALIR_B2			    ;SI NO ES IGUAL A 0
	
	CPI		ESTADO, 2
	BRNE	BE2
	INC		R7					;SI ES IGUAL A 0, INCREMENTAMOS
	MOV		R30, R7
	CPI		R30, 10
	BRNE	SALIR_B2
	CLR		R7

	INC		R6
	MOV		R30, R6
	CPI		R30, 6
	BRNE	SALIR_B2
	CLR		R7
	CLR		R6
	JMP		SALIR_B2

BE2:
	CPI		ESTADO, 3
	BRNE	SALIR_B2
		
	INC		R5
	MOV		R30, R5
	CPI		R30, 24
	BRNE	DIA3
	CLR		R5
	CLR		R7
	CLR		R6
	JMP		SALIR_B2
DIA3:
	INC		R7					;SI ES IGUAL A 0, INCREMENTAMOS
	MOV		R30, R7
	CPI		R30, 10
	BRNE	SALIR_B2
	CLR		R7

	INC		R6
	MOV		R30, R6
	CPI		R30, 3
	BRNE	SALIR_B2
	CLR		R7
	CLR		R6
	JMP		SALIR_B2
SALIR_B2:
	RET


;*********************
BOTON_3:
	SBIC	PINB, PB2			;VERIFICASMOS SI PINB0 ES IGUAL A 0
	RJMP	SALIR_B3			;SI NO ES IGUAL A 0
	
	CPI		ESTADO, 2
	BRNE	BE3
	MOV		R30, R7
	CPI		R30, 0
	BRNE	DEC3
	LDI		R30, 9
	MOV		R7, R30

	MOV		R30, R6
	CPI		R30, 0
	BRNE	DEC33
	LDI		R30, 5
	MOV		R6, R30	
	JMP		SALIR_B3	
DEC3:	
	DEC		R7					;SI ES IGUAL A 0, INCREMENTAMOS
	JMP		SALIR_B3
DEC33:	
	DEC		R6					;SI ES IGUAL A 0, INCREMENTAMOS
	JMP		SALIR_B3

BE3:
	CPI		ESTADO, 3
	BRNE	SALIR_B3
	
	MOV		R30, R5
	CPI		R30, 23
	BRNE	NO244
	LDI		R30, 3
	MOV		R7, R30	
	LDI		R30, 2
	MOV		R6, R30	
	DEC		R5
	JMP		SALIR_B3
NO244:
	MOV		R30, R5
	CPI		R30, 0
	BRNE	NO00
	LDI		R30, 24
	MOV		R5, R30
	JMP		SALIR_B3
NO00:
	MOV		R30, R7
	CPI		R30, 0
	BRNE	DEC333
	LDI		R30, 9
	MOV		R7, R30

	MOV		R30, R6
	CPI		R30, 0
	BRNE	DEC3333
	LDI		R30, 2
	MOV		R6, R30	
	JMP		SALIR_B3
DEC333:	
	DEC		R5
	DEC		R7					;SI ES IGUAL A 0, INCREMENTAMOS
	JMP		SALIR_B3
DEC3333:
	DEC		R5	
	DEC		R6					;SI ES IGUAL A 0, INCREMENTAMOS
	JMP		SALIR_B3

SALIR_B3:
	RET